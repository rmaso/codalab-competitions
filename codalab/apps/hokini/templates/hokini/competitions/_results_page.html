{% load i18n %}
{% load codalab_tags %}

{% if phase == None %}

{% elif error %}
    <p><strong>{% trans "Hay un problema en la clasificación" %}</strong></p>
    <p>{% trans "" %}¿Todos los nombres de columnas de la tabla de clasificación coinciden con las puntuaciones guardadas en scores.txt?</p>
    <pre>{{ error }}</pre>

{% elif phase.is_future and  block_leaderboard_view %}
    <p>{% trans "Esta fase aún no ha comenzado. La clasificación sigue estando oculta a los participantes, pero visible para los organizadores" %}</p>
{% elif phase.is_blind and not is_owner and not request.user in competition_admins %}
    <p>{% trans "Los organizadores de la competición han optado por mantener la clasificación privada. Por favor, vuelva más tarde." %}</p>
{% else %}
    {% if phase.is_blind and is_owner or phase.is_blind and request.user in competition_admins %}
        <p>{% trans "Los organizadores de la competencia han optado por mantener la clasificación privada, pero como organizador, puede acceder a esta página." %}</p>
    {% endif %}
    <div class="phase-description">
        {% if phase.description %}
            <h4>{% trans "Descripción" %}:</h4>
            <p>{{ phase.description }}</p>
        {% endif %}
    </div>
    <div class="leaderboard-result-table">
        {% for group in groups %}
            <table class="resultsTable dataTable">
                <tr class="table-title">
                    <th colspan="{{group.total_span|add:phase.competition.enable_medical_image_viewer|add:phase.competition.allow_teams|add:phase.competition.enable_detailed_results}}">{{group.label}}</th>
                </tr>
                <tr class="leaderboard-result-table-header">
                    <th rowspan="2">#</th>
                    <th rowspan="2">{% trans "Usuario"%}</th>
                    <th rowspan="2">{% trans "Participaciones"%}</th>
                    <th rowspan="2">{% trans "Fecha última participación"%}</th>
                    {% if phase.competition.allow_teams %}
                    <th rowspan="2">{% trans "Equipo"%}</th>
                    {% endif %}
                    {% for head in group.headers %}
                        {% if head.subs %}
                            <th colspan="{{head.subs|length}}">{{head.label}}</th>
                        {% else %}
                            <th rowspan="2" {% if group.selection_key == head.key %} class="column-selectable column-selected" {% else %} class="column-selectable" {% endif %} name="{{head.key}}">{{head.label}}
                            <span class="glyphicon glyphicon-play ascending-sorting" aria-hidden="true"></span>
                            </th>
                        {% endif %}
                    {% endfor %}
                    {% if phase.competition.enable_detailed_results %}
                        <th style="padding: 4px 0;">{% trans "Resultados detallados"%}</th>
                    {% endif %}
                    {% if phase.competition.enable_medical_image_viewer %}
                        <th>Image Viewer</th>
                    {% endif %}
                </tr>
                <tr>
                    {% for head in group.headers %}
                        {% if head.subs %}
                            {% for sub in head.subs %}
                                <th {% if group.selection_key == sub.key %} class="column-selectable column-selected" {% else %} class="column-selectable" {% endif %} name="{{sub.key}}">{{sub.label}}
                                    <span class="glyphicon glyphicon-play ascending-sorting" aria-hidden="true"></span>
                                </th>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </tr>
                {% if group.scores.items|length_is:"0" %}
                    <tr class="noData">
                        <td colspan="{{group.total_span|add:phase.competition.enable_medical_image_viewer|add:phase.competition.enable_detailed_results}}">{% trans "No hay datos disponibles en la tabla"%}</td>
                    </tr>
                {% else %}
                    {% for pk, scoredata in group.scores %}
                        <tr {% if phase.competition.anonymous_leaderboard and request.user.username == scoredata.username %}style="background-color: #D7FFFA;"{% endif %}>
                            <td class="row-position">
                                {{ forloop.counter }}
                            </td>
                            <td>
                                {% if phase.competition.anonymous_leaderboard %}
                                    <i>{% trans "Anónimo"%}</i>
                                {% else %}
                                    {{ scoredata.username }}
                                {% endif %}
                            </td>
                            <td> {{ scoredata.count }} </td>
                            <td> {{ scoredata.date|date:"m/d/y" }} </td>
                            {% if phase.competition.allow_teams %}
                            <td>{{ scoredata.team_name|default_if_none:"" }}</td>
                            {% endif %}
                            {% for head in group.headers %}
                                {% for head_or_sub in head|get_array_or_attr:'subs' %}
                                    {% with scoredata.values|get_by_name:head_or_sub.key|first as v %}
                                        {% if 'rnk' in v %}
                                            <td {% if group.selection_key == v.name %} class="column-selected" {% endif %} name={{v.name}}>{{v.val}} (<span class="rank">{{v.rnk}}</span>)</td>
                                        {% else %}
                                            <td {% if group.selection_key == v.name %} class="column-selected" {% endif %} name={{v.name}}>{{v.val}} <span class="rank hide">{{v.hidden_rnk}}</span></td>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            {% endfor %}
                            {% if phase.competition.enable_detailed_results %}
                                <td>
                                    <a href="/my/competition/submission/{{scoredata.id}}/detailed_results" target="_blank">
                                        View
                                    </a></br>
                                </td>
                            {% endif %}
{#                            {% if phase.competition.enable_medical_image_viewer %}#}
{#                                {% with "http://cirrusweb.cloudapp.net:8080/Packages/MeVisLab/Private/Sources/Web/application/Presentation.html?module=CodaLabViewer&useTiling=1" as viewerlink %}#}
{#                                    <td>#}
{#                                        <a href="{{viewerlink}}&imageData={{phase.input_data.name|get_sas}}&overlayData={{scoredata.resultLocation|get_sas}}" onclick="window.open('{{viewerlink}}&imageData={{phase.input_data.name|get_sas}}&overlayData={{scoredata.resultLocation|get_sas}}', '_blank', 'width=1000, height=1000, location=0'); return false;">#}
{#                                            View results#}
{#                                        </a>#}
{#                                    </td>#}
{#                                {% endwith %}#}
{#                            {% endif %}#}
                        </tr>
                    {% endfor %}
                {% endif %}
            </table>
        {% endfor %}

        <div class="spacer spacer-xs"></div>
    {% if groups|length > 0 %}
        <a class="icon-excel btn btn-default" href="/competitions/{{phase.competition.id}}/results/{{phase.id}}/data">{% trans "Descargar CSV" %}</a>
    {% endif %}
    {% if request.user == phase.competition.creator or request.user in phase.competition.admins.all %}
        <a class="icon-download btn btn-default" href="{% url "competitions:download_leaderboard_results" competition_pk=phase.competition.pk phase_pk=phase.pk %}">{% trans "Descargar todas las predicciones de la clasificación" %}</a>
    {% endif %}

        
        <div class="spacer spacer-xs"></div>
        <div >
               <p class="small"><b>{% trans "Max predicciones por día" %}: </b> {{ phase.max_submissions_per_day }}<br>
               <b>{% trans "Max predicciones total" %}: </b> {{ phase.max_submissions }}</p>
        </div>
    </div>


{% endif %}

{% extends 'base.html' %}

{% load i18n %}
{% load url from future %}
{% load staticfiles %}
{% load codalab_tags %}
{% load tz %}
{% load humanize %}

{% block nosubheader %}
{% endblock %}


{% block head_title %}{% trans "Competición" %}{% endblock %}
{% block page_title %}{% trans "Competición" %}{% endblock page_title %}

{% block extra_scripts %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>
    <script src="{{ STATIC_URL }}js/vendor/custom.modernizr.js"></script>
    <script src="{{ STATIC_URL }}js/vendor/readmore.min.js"></script>

    <script src="{{ STATIC_URL }}js/vendor/jquery.tablesorter.min.js"></script>

    <style>
    #public_submission_table th b {
        cursor: pointer;
    }
    </style>
{% endblock %}

{% block content %}

{% if request.user.is_staff %}
    <a href="{% url "competitions:download" competition_pk=competition.pk %}" class="btn btn-primary">DOWNLOAD COMPETITION BUNDLE!</a>
{% endif %}

{% if is_admin_or_owner %}
    <h3>Admin features</h3>
    <a href="{% url "competitions:edit" pk=competition.pk %}" class="btn btn-primary">Edit</a>
    <a href="{% url 'my_competition_participants' competition_id=competition.pk %}" class="btn btn-primary">
        Participants
        {% if comp_num_pending_teams > 0 %}
        <span class="glyphicon glyphicon-exclamation-sign" style="color:red">
        {% endif %}
    </a>
    <a href="{% url 'my_competition_submissions' competition_id=competition.pk %}" class="btn btn-primary">Submissions</a>
    <hr>
{% endif %}


<div class="competition-view">
    <div class="spacer spacer-xs"></div>
    <div class="row">
        <div class="col-sm-2 col-md-2">
            <div class="img-container">
                {% if competition.image_url == None %}
                    <img src="{% static 'img/ProfileImageDummy.jpg' %}" class="img-responsive">
                {% else %}
                    <img src="{{ competition.image_url }}" class="img-responsive">
                {% endif %}
            </div>
        </div>
        <div class="col-sm-8 col-md-8">
            <h3>{{ competition.title }}</h3>
            <p class="">{{competition.description}}</p>
            <p class="organizer">{{ competition.creator }} · {% trans "Fecha fin: " %} {{competition.end_date|date:"d-M-Y" }}</p>
        </div>
        <div class="col-sm-2 col-md-2">
            {% if competition.reward and competition.reward > 0 %}
                <h3 class="text-right"><b>{{ competition.reward|intcomma }} €</b></h3> 
            {% endif %}
            <p class="text-right"> <b>{{ competition.get_participant_count }}</b> {% trans "participante" %}{% if competition.get_participant_count > 1 %}s{% endif %}</p>
        </div>
            <input type="hidden" id="competitionId" value="{{competition.id}}" />
            <input type="hidden" id="cstoken" value="{{csrf_token}}" />
    </div>
    <section class="competition-tabs">
        <ul class="nav nav-tabs" id="competition_tab_nav">
            {% for tab, contents in tabs.items %}
                {% if tab.codename == "participate" %}
                    {# Put this before participate tab #}
                    {# <li><a href="#phases" role="tab" data-toggle="tab">{% trans "Fases" %}</a></li> #}
                {% endif %}
                <li><a href="#{{tab.codename|slugify}}" role="tab" data-toggle="tab">{{tab.name}}</a></li>
                {% if tab.codename == "results" %}
                    {# Put this after results tab #}
                    {% if competition.allow_public_submissions %}
                    <!--<li><a href="#public_submissions" role="tab" data-toggle="tab">Public submissions</a></li>-->
                    <li><a href="{% url 'competitions:public_submissions' pk=competition.pk%}">{% trans "Predicciones públicas" %}</a></li>
                    {% endif %}
                    {% if competition.enable_forum %}
                    <li><a href="{% url 'forum_detail' forum_pk=competition.forum.pk %}">{% trans "Foros" %} <i class="glyphicon glyphicon-log-in"></i></a></li>
                    {% endif %}
                    {% if competition.enable_teams %}
                        {% if my_status == "approved" %}
                            <li>
                                <a href="{% url 'team_detail' competition_pk=competition.pk %}">{% trans "Equipo" %}
                                    <i class="glyphicon glyphicon-cog"></i>
                                    {% if new_team_submission > 0 %}
                                        <span class="label label-danger">{{new_team_submission}}</span>
                                    {% endif %}
                                    {% if my_team_alert == 1 %}
                                        <span class="glyphicon glyphicon-exclamation-sign" style="color:red"></span>
                                    {% endif %}
                                </a>
                            </li>
                        {% endif %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        </ul>
        <div class="tab-content">
            {% for tab, contents in tabs.items %}
                {# Let's insert the "phases" tab just before participate #}
                {% if tab.codename == "participate" %}
                    <div class="tab-pane" id="phases">
                        <div class="tab-inner">
                            <div class="phase-list">
                                {% for phase in competition.phases.all %}
                                    <div class="phase-list-item panel phase-list-item-{% if phase.color %}{{ phase.color }}{% else %}default{% endif %}">
                                        <div class="panel-heading">
                                            <h3 class="panel-title">{{ phase.label }}</h3>
                                        </div>
                                        <div class="panel-body">
                                            <p><strong>Start:</strong> {{ phase.start_date }}</p>
                                            {% if phase.description %}
                                                <p><strong>Description:</strong> {{ phase.description }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                                <div class="phase-list-item panel phase-list-item-default phase-list-item-deadline">
                                <div class="panel-heading">
                                    <h3 class="panel-title"><strong>{% trans "La competición ha finalizado" %}</strong></h3>
                                </div>
                                <div class="panel-body">
                                    <p> {% if competition.end_date %} <strong>{{competition.end_date}}</strong>
                                    {% else %} <strong>Never</strong>
                                    {% endif %}
                                    </p>
                                </div>
                                </div>
                            </div>

                        </div>
                    </div>
                {% endif %}
                <div class="tab-pane" id="{{ tab.codename|slugify }}">
                    <div class="tab-inner">
                        {% if tab.codename == "participate" %}
                            {% if not user.is_authenticated %}
                                <p>Debes iniciar sesión para participar.</p>
                                <a href="{% url 'account_login' %}?next=/competitions/{{ competition.id }}%23participate-get-data" class="btn btn-primary">Sign In</a>
                            {% else %}
                                {% if my_status == "unknown" %}
                                    <form id="participate_form">
                                        {% csrf_token %}
                                        <p>Aún no te has registrado para esta competición.</p>
                                        <p>Para participar en este concurso, debe aceptar sus términos y condiciones específicos. Después de registrarte, el organizador del concurso revisará tu solicitud y te notificará cuando se apruebe tu participación.</p>
                                        <div class="checkbox">
                                            <label>
                                                <input type="checkbox" name="agreed_terms" id="checkbox" required onclick="Competition.registationCanProceed();">
                                                Acepto los <a href="#learn_the_details-terms_and_conditions" target="_blank">terminos y condiciones</a> de la competición.
                                            </label>
                                        </div>
                                        <input type="submit" id="participateButton" class="disabledStatus btn btn-primary margin-top" value='{% trans "Aceptar" %}' />
                                    </form>
                                {% elif my_status == "pending" %}
                                    <p>Se ha recibido su solicitud de participar en este desafío y está pendiente una decisión.</p>
                                {% elif my_status == "denied" %}
                                    <p>Tu solicitud de participar en este concurso ha sido denegada o sus privilegios se han suspendido.</p>
                                    {% if my_participant.reason %}
                                        <p>Razón: {{my_participant.reason}}</p>
                                    {% endif %}
                                {% endif %}
                                {% if my_status == "approved" %}
                                    {% include "web/competitions/_innertabs.html" %}
                                {% endif %}
                            {% endif %}
                        {% elif tab.codename == 'results' %}
                            {% include "web/competitions/_results.html"%}
                        {% else %}
                            {% include "web/competitions/_innertabs.html" %}
                        {% endif %}
                    </div>
                </div>

            {% endfor %}
        </div>
    </section>
</div>

{% endblock content %}

{% block jsincludes %}
    <script>
        $('#view_all_phases').on('click', function(e){
            $('#competition_tab_nav a[href="#phases"]').tab('show');
        });
        $(function(){
            var show_location = function(hash) {
                var main_tab = hash.split('-')[0];
                var sub_tab = hash.split('-')[1];

                $('#competition_tab_nav a[href="' + main_tab + '"]').tab('show');
                $(main_tab + ' .innertabs a[href="' + main_tab + '-' + sub_tab + '"]').tab('show');
            };

            if(location.hash !== ''){
                show_location(location.hash);
            }else {
                $('#competition_tab_nav a:first').tab('show')
            }
            $('#competition_tab_nav a, .innertabs a').on('show.bs.tab', function(e){
                return location.hash = $(e.target).attr('href').substr(1);
            });
            if($('#participate-submit_results').hasClass('active')){
                $('#submissions_phase_buttons .active').click();
            } else if($('#results').hasClass('active')){
                $('#results_phase_buttons .active').click();
            };
            $('a[href="#participate-submit_results"]').on('shown.bs.tab', function(e){
                $($(e.target).attr('href') + ' .active').click();
            });
            $('a[href="#results"]').on('shown.bs.tab', function(e){
                $($(e.target).attr('href') + ' .active').click();
            });

            $('#learn_the_details .col-sm-9 a').on('click', function() {
                show_location('#' + $(this).attr('href').split('#')[1]);
            });
        });

    </script>
{% endblock %}

{% block extra_headers %}
    {{ submission_upload_form.media }}
{% endblock %}
